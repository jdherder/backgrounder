<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Backgrounder</title>

        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="css/main.css">

        <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="img-row clearfix">
            <img class="base-img img-repeat" src="images/default.gif" />
        </div>

        <div id="settings-dialog" class="hide">
            <div>
                <div class="option-group">
                    <div class="option">url:</div>
                    <div class="option"><input type="text" id="url" class="input-url" value="http://i.giphy.com/zqPm7bAHRu8Xm.gif" /></div>
                </div>
                <div class="option-group">
                    <div class="option">width:</div>
                    <div class="option slider-container"><div id="slider"></div></div>
                    <div class="option"><span id="amount-display"></span></div>
                </div>
                <div>imgPerRow: <span id="imgPerRow"></span> | rowsPerPage: <span id="rowsPerPage"></span></div>
            </div>
        </div>

        <div class="settings_container">
            <img src="images/gear39.png" class="settings" />
        </div>

        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>

        <script>
            localStorage.setItem("imgPerRowSave",0);
            localStorage.setItem("rowsPerPageSave",0);

            $(window).resize(function() {
                var windowWidth = $(window).width();
                var windowHeight = $(window).height();
                var imgWidth = $('.base-img').width() || 1;
                var imgHeight = $('.base-img').height() || 1;

                var imgPerRow = Math.ceil(windowWidth / imgWidth);
                var rowsPerPage = Math.ceil(windowHeight / imgHeight);

                $('.base-img').hide();

                attemptRender(imgPerRow, rowsPerPage);

                $('#imgPerRow').html(imgPerRow);
                $('#rowsPerPage').html(rowsPerPage);

            });
            $(window).resize();

            $("#settings-dialog").dialog({
                autoOpen: false,
                maxWidth: 400,
                maxHeight: 400,
                width: 400,
                height: 400,
                modal: true,
                buttons: {
                    "Done": function() {
                        $(this).dialog("close");
                    }
                }
            });

            $('.settings').click(function() {
                $('#settings-dialog').dialog('open');
            });

            $('#url').blur(function() {
                var url = $('#url').val();
                //$('body').css('background-image', 'url(' + url + ')');
                $('.img-repeat').each(function(index) {
                    $(this).attr("src",url);
                });
            });

            $('#slider').slider({
                value: 300,
                min: 0,
                max: 1000,
                step: 10,
                slide: function( event, ui ) {
                    $('#width').val( ui.value );
                    $('#amount-display').html( $('#slider').slider('value') + 'px');
                    //$('body').css("background-size", $('#slider').slider( "value" ) + 'px');

                    $(window).resize();
                    $('.img-repeat').each(function(index) {
                        $(this).attr("width", $('#slider').slider( "value" ) + 'px');
                    });
                }
            });

            $('#amount-display').html( $('#slider').slider('value') + 'px');

            function attemptRender(imgPerRow, rowsPerPage) {

                var imgPerRowSave = localStorage.getItem("imgPerRowSave");
                var rowsPerPageSave = localStorage.getItem("rowsPerPageSave");

                console.log('imgPerRow: ', imgPerRow, ' imgPerRowSave: ', imgPerRowSave);
                console.log('rowsPerPage: ', rowsPerPage, ' rowsPerPageSave: ', rowsPerPageSave);

                if (imgPerRow == imgPerRowSave && rowsPerPage == rowsPerPageSave) {
                    return;
                }

                var url = $('#url').val();

                $('.remove-handle').remove();

                for (var i = 0; i < imgPerRow; i++) {
                    var imgClone = '<img src="' + url + '" class="img-repeat remove-handle" />';
                    $('.img-row').append(imgClone);
                    console.log('imgPerRow: ', imgPerRow);
                }
                for (var j = 0; j < rowsPerPage; j++) {
                    var cloned = $('.img-row').first().clone();
                    cloned.addClass('remove-handle');
                    cloned.appendTo('body'); //this is an exponential copy
                    console.log('rowsPerPage: ', rowsPerPage);
                }

                localStorage.setItem("imgPerRowSave",imgPerRow);
                localStorage.setItem("rowsPerPageSave",rowsPerPage);
            }

        </script>

    </body>
</html>